services:
  ipfs:
    image: ipfs/go-ipfs:latest
    volumes:
      - ./data/ipfs:/data/ipfs
    ports:
      - "4001:4001"
      - "5001:5001"
      - "8080:8080"
    command: daemon --migrate --init
    restart: unless-stopped
    networks:
      default:
        aliases:
          - ipfs_node

  spark-master:
    image: apache/spark:4.0.0-preview2
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_LOCAL_IP=spark-master
      - SPARK_CONF_DIR=/opt/spark/conf
    ports:
      - "7077:7077"
      - "8081:8080"
    volumes:
      - ./spark-app:/opt/spark/work-dir
      - ./tmp:/tmp
    command: "/opt/spark/bin/spark-class org.apache.spark.deploy.master.Master"

  spark-worker:
    image: apache/spark:4.0.0-preview2
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_CORES=1
      - SPARK_WORKER_MEMORY=1g
      - SPARK_DRIVER_MEMORY=512m
      - SPARK_EXECUTOR_MEMORY=512m
      - SPARK_LOG_LEVEL=DEBUG
      - SPARK_CONF_DIR=/opt/spark/conf
    volumes:
      - ./spark-app:/opt/spark/work-dir
      - ./tmp:/tmp 
    depends_on:
      - spark-master
      - ipfs
    command: "/bin/bash -c '/opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 --webui-port 8081'"

  node-app:
    build:
      context: ./node_app
    volumes:
      - ./node_app:/app
    ports:
      - "3000:3000"
    depends_on:
      - ipfs
      - spark-master
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
    command: flask run --host=0.0.0.0 --port=3000
